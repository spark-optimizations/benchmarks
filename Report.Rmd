---
title: "Assignment Report - A8(A7)"
author: "Shabbir"
date: "October 31, 2017"
output:
  html_document: default
  pdf_document:
    fig_crop: no
    fig_width: 5
    latex_engine: xelatex
---

```{r setup, echo=F, results='hide',message=F, warning=F, cache=F}
library("ggplot2")
library("tidyr")
library("knitr")
library("kableExtra")
library("scales")
library("plyr")
library("microbenchmark")
library("reshape2")
library("readr")

library("tm")
library("SnowballC")
library("wordcloud")
library("RColorBrewer")
library("grid")
library("gridBase")
library("gridExtra")
library("dplyr")
```

```{r cache=TRUE,echo=F, results = 'asis', warning=F, message=F}
data <- read.csv('results/stats/timings.csv', sep="\t", header = FALSE)
data <- data[, c("V1", "V3")]
```

```{r cache=TRUE,echo=F, results = 'asis', warning=F, message=F}
dfRun <- subset(data, substring(data$V1, 0, 3) == "run")
dfRun$V1 <- substring(dfRun$V1, 5)
dfRun %>%
  group_by(V1) %>% 
  summarise(Mean=mean(V3), Median=median(V3)) %>%
  separate("V1", into = paste("V", 1:3, sep = "_")) -> dfRun

colnames(dfRun) <- c("Type", "Tot", "Used", "TimeMean", "TimeMedian")
dfRun$Tot <- as.integer(dfRun$Tot)
dfRun$Used <- as.integer(dfRun$Used)
dfRun <- subset(dfRun, Tot!=0)
```
```{r cache=TRUE,echo=F, results = 'asis', warning=F, message=F}
ggplot(data=dfRun, aes(x=reorder(as.factor(Tot), Tot), y=reorder(as.factor(Used), Used), fill=TimeMedian)) +
    geom_tile(width=1, height=1) + 
    scale_fill_gradient(low="white", high="red", name="Time (sec)") +
    labs(x="Total # Columns", y="Used # Columns", title="title") + 
    theme_bw()
```

    scale_fill_gradient(low="grey", high="black", name="Time (sec)") +

















```{r cache=TRUE,echo=F, results = 'asis', warning=F, message=F}



niceLabels <- function(x) ifelse(x>=1000000, paste0(x/1000000,"mln"), ifelse(x==0, x, paste0(x/1000,"k")))

plotClust1D <- function(data, subset_name, labArr, rounding=0, scaling=1, title="", xlabel="", ylabel="", ysuffix="", xsuffix=""){
  dataP <- subset(data, PROB_NAME==subset_name)
  
  minCId = dataP[(order( dataP$X)), ][1, ]$CLUSTER_ID
  maxCId = dataP[(order(-dataP$X)), ][1, ]$CLUSTER_ID
  
  dataP <- dataP %>% mutate(CLUSTER_ID = ifelse(CLUSTER_ID == minCId, labArr[1], ifelse(CLUSTER_ID == maxCId, labArr[3], labArr[2])))
  
  cntByCltrX   <- dataP %>% group_by(CLUSTER_ID, X=round(X/scaling, rounding)) %>% count
  xMeanByCltr  <- cntByCltrX %>% group_by(CLUSTER_ID) %>% summarise(X_MEAN = round(mean(X), 0)) 
  cntByCltrX   <- merge(cntByCltrX, xMeanByCltr, by = "CLUSTER_ID")
  
  cntByCltr    <- cntByCltrX %>% group_by(CLUSTER_ID) %>% summarise(n = sum(n)) 
  cntByCltr$n  <- round(cntByCltr$n * 100/ sum(cntByCltr$n), 0)
  arrange(cntByCltr, desc(CLUSTER_ID))
  
  cntByCltrY <- setNames(data.frame(matrix(ncol = 3, nrow = 0)), c("CLUSTER_ID", "Y", "LABEL"))
  tot = 0
  for(i in 1:nrow(cntByCltr)) {
      clstrRow <- cntByCltr[i,]
      for(j in 1:clstrRow$n){
        tot = tot+1
        label <- ""
        if (j==round(clstrRow$n/2,0)) {label <- substring(clstrRow$CLUSTER_ID, 2)}
        cntByCltrY[nrow(cntByCltrY) + 1,] = list(clstrRow$CLUSTER_ID, tot, label)
      }
  }
  cntByCltrXY <- merge(cntByCltrX, cntByCltrY, by = "CLUSTER_ID")
  cntByCltrXY <- cntByCltrXY %>% mutate(LABEL = ifelse(X == X_MEAN, LABEL, ""))
  
  
  ggplot(data=cntByCltrXY, aes(x=X, y=Y, fill=n)) +
    geom_tile(width=1, height=1) +
    scale_fill_gradient(low="grey", high="black", name="Songs") +
    labs(x="", y="Cummulative % of Songs", title=title) +
    scale_color_continuous(labels=niceLabels) +
    scale_x_continuous(labels=function(x) dollar_format(suffix = xsuffix, prefix = "")(x)) +
    scale_y_continuous(labels=function(x) dollar_format(suffix = " %", prefix = "")(x)) +
    geom_text(aes(x=max(X)+5, y=Y, label=paste(LABEL, "", " ")), size=4) + 
    theme_bw()
}


plotClust2D <- function(data, subset_name, labArr, rounding=0, scaling=1, title="", xlabel="", ylabel="", ysuffix="", xsuffix=""){
  dataP <- subset(data, PROB_NAME==subset_name)
  dataP <- dataP %>% mutate(X = round(X/scaling, rounding), Y = round(Y/scaling, rounding))
  
  
  minCId = dataP[(order( dataP$X)), ][1, ]$CLUSTER_ID
  maxCId = dataP[(order(-dataP$X)), ][1, ]$CLUSTER_ID
  
  dataP <- dataP %>% mutate(CLUSTER_ID = ifelse(CLUSTER_ID == minCId, labArr[1], ifelse(CLUSTER_ID == maxCId, labArr[3], labArr[2])))
  
  plt.comb <- ggplot(data=dataP, aes(x=X, y=Y, color=CLUSTER_ID)) +
    geom_density_2d() +
    labs(x=xlabel, y=ylabel, title=title) +
    scale_x_continuous(labels=function(x) dollar_format(suffix = xsuffix, prefix = "")(x)) +
    scale_y_continuous(labels=function(x) dollar_format(suffix = " %", prefix = "")(x)) +
    scale_color_manual(values=brewer.pal(4, "Greys")[2:4]) + 
    theme(legend.position="none", panel.background = element_blank(), axis.line = element_line(colour = "black"), panel.grid.major = element_line(color="lightgrey"))
  
  cntByCltr <- dataP %>% group_by(CLUSTER_ID) %>% count
  plt.cnt <- 
    ggplot(data=cntByCltr, aes(x="", y=n, fill=CLUSTER_ID)) +
    geom_bar(width=1, stat="identity", position=position_stack(reverse = T)) +
    geom_label(aes(label=paste0(CLUSTER_ID, ": ", format(n/sum(n)*100, digits=0), "%")), 
               position=position_stack(reverse = T)) +
    labs(title="", subtitle="", y="Songs") +
    scale_y_continuous(position="right", labels=niceLabels) +
    theme(axis.title.x=element_blank(), legend.position="none", axis.ticks.x=element_blank(), panel.background = element_blank()) +
     scale_fill_manual(values=brewer.pal(4, "Greys")[2:4]) 
 
  grid.arrange(plt.comb, plt.cnt, ncol=2, widths=c(5,1))
}

```

### Abstract

This report describes results of different kinds of clustering on the million songs dataset. Detailed requirements can be found [here](http://janvitek.org/pdpmr/f17/task-a7-clustering.html). The first section describes the experiment design, setup and brief structure of project. Followed by second section starts with results visualization and analysis of subtasks including run time statistics. Finally we conclude with findings from both sections.

# 1. Design of experiment

<table><tr><td>
```{r cache=TRUE, fig.cap="Figure 1", fig.align='center', fig.width=20, fig.height=10, echo=F}
img <- readPNG("docs/images/DesignDiagram.png")
grid.raster(img)
```
</td><td valign="top">
Our clustering architecture for subtask 1 is a single 2d clustering algorithm which takes 2d points RDD and returns 3 clusters from those points as set of points assigned to centeroids. For each problem within subtask we filtered data and passed an RDD of just $(x,y)$ coordinates. For 1d clustering $y$ coordinate is set to static value.

Case classes were intentionally not used in the code as it made the code lines longer and incur added penalty for pattern matching. Instead tuples with comments convention is used throughout the code.

We ran all experiments on a MacBookPro12 with 1 Intel Core i5 processor (2.7 GHz, 2 cores) with 8 GB ram.
</td></tr></table>

# 2. Results



```{r cache=TRUE,fig.align='center', fig.cap="Figure 2", echo=FALSE, results = 'asis', warning=FALSE, message=FALSE, fig.height=3.5, fig.width=10}
plt.loudness <- plotClust1D(data, subset_name="L", labArr=c("1 Quiet", "2 Med", "3 Loud"), title="Fuzzy Loudness (1 db buckets)", xlabel="Loudness", xsuffix=" db", rounding=0)

plt.length <- plotClust1D(data, subset_name="N", labArr=c("1 Short", "2 Med", "3 Long"), title="Fuzzy Length (30 sec buckets)", xlabel="Length", xsuffix=" min", scaling=30)

plt.tempo <- plotClust1D(data, subset_name="T", labArr=c("1 Slow", "2 Med", "3 Fast"), title="Fuzzy Tempo (3 BPM buckets)", xlabel="Tempo", xsuffix=" BPM", rounding=0, scaling=3)

plt.hot <- plotClust1D(data, subset_name="H", labArr=c("1 Cool", "2 Mild", "3 Hot"), title="Fuzzy Song Hotness (1% buckets)", xlabel="Hotness", xsuffix=" %", rounding=3, scaling=.01)

grid.arrange(plt.loudness, plt.length, plt.tempo, plt.hot, ncol=2, nrow=2)

```


#### Assumptions and Specifications


## Conclusion

